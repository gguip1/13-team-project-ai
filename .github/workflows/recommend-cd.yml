name: Recommend CD Pipeline
run-name: Recommend CD â€¢ ${{ github.event.workflow_run.head_sha }}

on:
  workflow_run:
    workflows: ["Recommend CI Pipeline"]
    types: [completed]

permissions:
  contents: read
  actions: read

concurrency:
  group: recommend-cd-${{ github.workflow }}-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  deploy:
    if: >-
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&
        (github.event.workflow_run.head_branch == 'develop' ||
        github.event.workflow_run.head_branch == 'main')
      }}
    runs-on: ubuntu-24.04-arm
    env:
      REPO_URL: https://github.com/${{ github.repository }}.git
      REPO_PATH: /home/${{ secrets.SSH_USER }}/13-team-project-ai
      SERVICE_DIR: services/recommend
      VENV_PATH: /home/${{ secrets.SSH_USER }}/.venvs/recommend
      DEPLOY_BRANCH: ${{ github.event.workflow_run.head_branch }}
      RESTART_CMD: sudo systemctl restart recommend

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s' "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy (fetch/reset + install + restart)
        run: |
          ssh -p "${{ secrets.SSH_PORT }}" \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
            "REPO_URL='${REPO_URL}' REPO_PATH='${REPO_PATH}' SERVICE_DIR='${SERVICE_DIR}' VENV_PATH='${VENV_PATH}' DEPLOY_BRANCH='${DEPLOY_BRANCH}' RESTART_CMD='${RESTART_CMD}' bash -s" <<'EOF'
          set -euo pipefail

          if [ ! -d "$REPO_PATH/.git" ]; then
            if [ -e "$REPO_PATH" ]; then
              echo "Path exists but is not a git repository: $REPO_PATH"
              exit 1
            fi
            mkdir -p "$(dirname "$REPO_PATH")"
            git clone --branch "$DEPLOY_BRANCH" --depth 1 "$REPO_URL" "$REPO_PATH"
          else
            cd "$REPO_PATH"
            git fetch --prune origin
            git reset --hard "origin/$DEPLOY_BRANCH"
          fi

          cd "$REPO_PATH"

          cd "$SERVICE_DIR"
          if [ ! -d "$VENV_PATH" ]; then
            python3 -m venv "$VENV_PATH"
          fi

          . "$VENV_PATH/bin/activate"
          python -m pip install --upgrade pip
          pip install -r requirements.txt

          if [ -n "$RESTART_CMD" ]; then
            eval "$RESTART_CMD"
          else
            echo "RESTART_CMD is empty; skipping restart."
          fi
          EOF
