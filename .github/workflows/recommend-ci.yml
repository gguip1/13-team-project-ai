name: AI RECOMMEND CI Pipeline

on:
  pull_request:
    branches: [main, develop]
    paths:
      - "services/recommend/**"
      - ".github/workflows/recommend-ci.yml"
      - ".github/workflows/recommend-cd.yml"
  push:
    branches: [main, develop]
    paths:
      - "services/recommend/**"
      - ".github/workflows/recommend-ci.yml"
      - ".github/workflows/recommend-cd.yml"

permissions:
  contents: read

concurrency:
  group: recommend-ai-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-24.04-arm
    defaults:
      run:
        working-directory: services/recommend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-dev.txt

      # Lint/Format: 경고만 (CI 블록 안함)
      # Type/Test: 실패 시 CI 실패
      - name: Lint (ruff)
        id: lint
        continue-on-error: true # 경고만
        run: ruff check . --output-format=github

      - name: Format check (ruff)
        id: format_check
        continue-on-error: true # 경고만
        run: ruff format --check --diff .

      - name: Type check (mypy)
        id: typecheck
        run: mypy app --ignore-missing-imports

      - name: Run tests (pytest)
        id: test
        # || [ $? -eq 5 ]: 테스트 파일 없으면 통과 (TODO: 테스트 추가 후 제거)
        run: pytest -v --tb=short || [ $? -eq 5 ]

      - name: Notify Discord
        if: always()
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          EVENT: ${{ github.event_name }}
          BRANCH: ${{ github.ref_name }}
          PR_NUM: ${{ github.event.pull_request.number }}
          RUN_NUM: ${{ github.run_number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            TITLE="AI Recommend CI 성공"
            DESC="코드 검증이 완료되었습니다."
            COLOR=3066993
          else
            TITLE="AI Recommend CI 실패"
            DESC="코드 검증에 실패했습니다. 로그를 확인해주세요."
            COLOR=15158332
          fi

          if [ "$EVENT" = "pull_request" ]; then
            REF="PR #$PR_NUM"
          else
            REF="$BRANCH"
          fi

          # 각 단계 결과 (success/failure)
          LINT="${{ steps.lint.outcome }}"
          FORMAT="${{ steps.format_check.outcome }}"
          TYPE="${{ steps.typecheck.outcome }}"
          TEST="${{ steps.test.outcome }}"

          jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESC" \
            --arg color "$COLOR" \
            --arg event "$EVENT" \
            --arg ref "$REF" \
            --arg run_num "$RUN_NUM" \
            --arg lint "$LINT" \
            --arg format "$FORMAT" \
            --arg type "$TYPE" \
            --arg test "$TEST" \
            --arg url "$RUN_URL" \
            '{
              embeds: [{
                title: $title,
                description: $desc,
                color: ($color | tonumber),
                fields: [
                  {name: "이벤트", value: $event, inline: true},
                  {name: "대상", value: $ref, inline: true},
                  {name: "빌드", value: ("#" + $run_num), inline: true},
                  {name: "Lint", value: $lint, inline: true},
                  {name: "Format", value: $format, inline: true},
                  {name: "Type", value: $type, inline: true},
                  {name: "Test", value: $test, inline: true},
                  {name: "상세", value: ("[Actions 로그](" + $url + ")"), inline: false}
                ],
                footer: {
                  text: "AI Recommend CI",
                  icon_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                }
              }]
            }' | curl -sf -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-
